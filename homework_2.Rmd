---
title: "Homework 2"
author: "Åžuheda Buse Erduran"
date: "2022-05-09"
output: html_document
---

# Homework 2: Forecasting With Regression

The aim of this homework is understanding the characteristics of the data and then forecasting the Unleaded Gasoline Sale for the Quarters of 2007 with the help of time series regression methods. The data has 10 types of variables such as Price of Unleaded Gasoline (PU) and Price of Diesel Gasoline (PG) and Unleaded Gasoline Sale (UGS) at the beginning of the data. This data set consists of 8 years (2000-2007) and 32 Quarters accordingly. The task is to analyze the behavior of the UGS and put it in a linear regression model for forecasting UGS values of 2007.

The packages that are needed for this homework are implemented below:
```{r setup, include=FALSE}
library(readxl)
library(lubridate)
library(zoo)
library(ggplot2)
library(RcppRoll)
library(GGally)
library(skimr)
library(forecast)
library(dplyr)
library(data.table)
```

## 1) Data Gathering and Manipulations

The excel file is read, Quarters are shown as date to R and column names are changed for an easy usage:
```{r cars}
data=read_xlsx("IE360_Spring22_HW2_data.xlsx",sheet=1, col_names=TRUE)
names(data)
data$Quarter= as.Date(as.yearqtr(data$Quarter,format="%Y_Q%q"))

colnames(data)= c("Quarter","UGS","RNUV","NLPG","PU","PG","NUGV","NDGV","GNPA","GNPC","GNP")

```

The variables:

**UGS:** Unleaded gasoline sale for the given quarter

**RNUV:** An index that indicates the rate of new unleaded gasoline by using vehicles being added to the traffic in a quarter

**PU:** Average price (adjusted with an index) of a liter of unleaded gasoline for the given quarter

**PG:** Average price (adjusted with an index) of a liter of diesel gasoline for the given quarter

**NUGV:** Number of unleaded gasoline using vehicles in the traffic

**NDGV:** Number of diesel gasoline using vehicles in the traffic (per 1000 people)

**GNPA:** Agriculture component of Gross National Product (adjusted with an index)

**GNPC:** Commerce component of Gross National Product (adjusted with an index)

**GNP:** Grand total for GNP (agriculture, commerce and other components total).



## 2) Data Visualizations Before Regression
The UGS part of the data is plotted so that the data can be interpreted before any change on the data.

```{r pressure}
ggplot(data, aes(x=Quarter,y=UGS))+
  geom_path(group=1,size=1,color='blue')+
  geom_point()+
  labs(title = "Unleaded Gasoline Sales Over the Quarters")+theme_classic()+scale_x_date(date_breaks = "1 year", date_labels = "%Y")
```

As can be seen at the plotted line, there is a declining behaviour in the data. It means that there is a declining trend on the Unleaded Gasoline Sales. Also, for every year, the third quarter has the biggest value and generally increase between the first and the second quarter. This can be a signal of seasonality on the data.
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r meanvar}
data_mean=roll_mean(data$UGS[1:28],4,align='left')
data_var=roll_var(data$UGS[1:28],4,align='left')
plot(data_mean,
     type='l',col='green',
     xlab = "time (t)",
     ylab = "Rolling Mean",
     main = "Mean series")

plot(data_var,
     type='l',col='green',
     xlab = "time (t)",
     ylab = "Rolling Variance",
     main = "Variance series")
```

By looking at the rolling mean series of UGS, it can be said that the data is clearly not stationary, one can see the trending line by looking at that plot. However, there is no visible proof of non-stationarity with respect to variance. By seeing only the rolling variance series, non-stationarity cannot be observed.
```{r autocorr}
acf(data$UGS,lag.max=12,na.action=na.pass)
```
This autocorrelation plot shows that there is high autocorrelation at lag 1, this means that there might be a trend in the data. Also, the high autocorrelation values at lags which are the multiples of 4 means that the idea of a seasonality is more possible now. 

## 3) Model Building for Linear Regression

To understand the correlations between the variables at once in a single plotted table. the ggpairs function is used. This way, the variables which has the strongest correlations with UGS is seen. Also, The seasonality variable is added with the name 'Q'.
```{r season}
ggpairs(data, cardinality_threshold=32)
Q=seq(1,4,by=1)
data=cbind(data,Q)
modelseason =lm(UGS~Quarter+as.factor(Q),data=data)
summary(modelseason)
checkresiduals(modelseason$residuals)
```
As can be seen at the table NUGV,NLPG, GNPA and PG has strong correlations with the UGS.


To see the difference after adding the Trend variable on the data, Trend variable is added as a series from 1 to 32 and named as 'T'. Then, the data is modeled by only considering the Trend variable. 

```{r trend}
T=seq(1,32,by=1)
data=cbind(data,T)
modeltrend =lm(UGS~T,data=data)
summary(modeltrend)
checkresiduals(modeltrend$residuals)
```
Trend predictor has a very small p-value. This can be a sign that it is a good predictor. Seasonality can be observed from the residuals (de-trended UGS). Also, it can be observed at ACF plot, because at the multiples of 4, the data has significant positive correlation.


After the model which only consists of Trend, the season variable is added to the model and another model is created.

```{r echo=TRUE, include=TRUE, warning=FALSE, message=FALSE}
modeltrendseason =lm(UGS~Quarter+T+as.factor(Q),data=data)
summary(modeltrendseason)
checkresiduals(modeltrendseason$residuals)
```
All predictors have significant coefficients (we can see that as small p-values) which means UGS can really be explained by trend and seasonality, and this model is also a good model. The autocorrelation for data 2 is at the upper limit line. This means that the big autocorrelation problem is solved widely.

The variables which have big correlations are added.

```{r try}
modelall =lm(UGS~Q+NLPG+NUGV+PG+PU+GNPA+NDGV+as.factor(Q),data[1:28,])
summary(modelall)
checkresiduals(modelall$residuals)
```
P- value is bigger than the previous with this variables.

By checking the first model it can easily be seen that good p-value is shown on F test and a great Adjusted R-squared value however there are many insignificant independent variables in the model, this might be a problem. Biggest issue, however, is that there is an autocorrelation at lag 1 in residuals which is seen because the Trend variable is not used.

After that, only the biggest correlated with UGS, which is NUGV is used.

```{r echo=TRUE, include=TRUE, warning=FALSE, message=FALSE}
modelNUGV=lm(UGS~NUGV+as.factor(Q),data=data)
summary(modelNUGV)
checkresiduals(modelNUGV$residuals)
```
The P-value is even better at this point.


From there, the next model is built which only included significant independent variables.. However, this approach made the adjusted R-square value worse and autocorrelations of the residuals.

```{r echo=TRUE, include=TRUE, warning=FALSE, message=FALSE}
modell =lm(UGS~as.factor(Q)+NLPG+NUGV+PU+NDGV,data=data)
summary(modell)
checkresiduals(modell$residuals)
```
For this model,one of those independent variables from previous model is added which helped with the model. However, the issues with residuals persisted.



```{r echo=TRUE, include=TRUE, warning=FALSE, message=FALSE}
data$NUGVlag1=lag(data$NUGV,1)
modellag=lm(UGS~as.factor(Q)+NDGV+NUGVlag1+NUGV+PU,data=data)
summary(modellag)
checkresiduals(modellag$residuals)
```
Because the time series was not stationary with respect to mean and showed great autocorrelation at lag 1,  several lag 1 variables are tried of the independent variables that was in the previous one. This model is one of the examples, even though the autocorellation at lag 1 got better, it is still not inside the limits.


Lastly, the lag 1 variable of the UGS itself is added which can be convincing regarding the model's being good enough. 
```{r echo=TRUE, include=TRUE, warning=FALSE, message=FALSE}
data$UGSlag1=lag(data$UGS,1)
modellag2 =lm(UGS~as.factor(Q)+NDGV+UGSlag1+NUGV+PU,data=data)
summary(modellag2)
checkresiduals(modellag2$residuals)
mean = mean(modellag2$residuals)
paste("Mean of the residuals:",mean)
model= modellag2
```
 Even though UGSlag1 variable is not significant, this model has a great adjusted R-squared value and p-value. In addition, mean of the residuals is practically zero and the shape of the distribution strongly seems like the normal distribution. Most importantly, there is no autocorrelation at any lag for the residuals. With respect to these observations, continuing on with this model is decided.


## 4) Forecasting With Regression

Before moving on with forecasting, what the model predicts for the quarters we already have the data on is shown. Thus,  predicted UGS values with the UGS data is plotted in the same graph. As can be seen below, model works fairly well.
```{r echo=FALSE, include=TRUE, warning=FALSE, message=FALSE}
tmp=copy(data)
tmp$actual=data$UGS
tmp$predicted=predict(model,tmp)
ggplot(tmp ,aes(x=Quarter))+
  geom_line(aes(y=actual,color='real')) + 
  geom_line(aes(y=predicted,color='predicted'))+
  labs(title = "Predicted vs Real UGS Values Over the Quarters",y="UGS (1000 m3)" )
```


```{r echo=TRUE, include=TRUE, warning=FALSE, message=FALSE}
set2007= data[29:32,c("Q","NDGV","UGSlag1","NUGV","PU")]
prediction = c(0,0,0,0)
for(i in 1:4) {
  prediction[i] = predict(model,newdata = set2007[i,])
  if(i<4){set2007[i+1,"UGSlag1"] = prediction[i] }
}
prediction
```

At the end, 2007 UGS values for each quarter are forecasted. Since the model needs UGSlag1 data, predictions of the previous quarter for quarters 2,3 & 4 are used.

## 5) Conclusion
The aim of this homework was analyzing the UGS data with respect to several independent variables and building a model of regression in order to be used for forecasting. In the end, the selected model suggested that UGS depends on NDGV,NUGV, and PU. In addition, it included seasonality, trend and lagged variables. variables.